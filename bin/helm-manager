#!/bin/bash

set -eu

# Inputs to this script come from:
# * http://jayunit100.blogspot.com/2017/07/helm-on.html
# * https://github.com/helm/helm/blob/master/docs/tiller_ssl.md

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $DIR/..

export CERTS_YAML=${CERTS_YAML:-certs.yml}
export HELM_HOME=${HELM_HOME:-$(helm home)}

[[ "$(which bosh)X" == "X" ]] && {
  echo "ERROR: please install 'bosh' CLI to generate certificates"
  exit 1
}

usage() {
    echo "Helm/Tiller Deployment Manager CLI"
    echo "  up   -- deploys the Tiller to current Kubernetes context"
    echo "  down -- deletes to current Kubernetes context"
}

up() {
  set -x
  [[ -d ${HELM_HOME} ]] || {
    echo "Installing helm into current Kuberenetes context..."
    kubectl apply -f ./src/helm.yaml

    helm init --service-account helm \
      --tiller-tls \
      --tiller-tls-verify \
      --tls-ca-cert     <(int --path /tiller/tls/ca) \
      --tiller-tls-cert <(int --path /tiller/tls/certificate) \
      --tiller-tls-key  <(int --path /tiller/tls/private_key) \
      --override 'spec.template.spec.containers[0].command'='{/tiller,--storage=secret}'
  }

  echo "Storing certificates into ${HELM_HOME}..."
  int --path /tiller/tls/ca          > "${HELM_HOME}/ca.pem"
  int --path /tiller/tls/certificate > "${HELM_HOME}/cert.pem"
  int --path /tiller/tls/private_key > "${HELM_HOME}/key.pem"

  echo "Testing connection"
  # helm ls --tls
}

down() {
  set +e
  kubectl delete deployment tiller-deploy --namespace=kube-system
  kubectl delete service tiller-deploy --namespace=kube-system
  kubectl delete secret tiller-secret -n kube-system
  kubectl delete -f ./src/helm.yaml
  rm -rf ~/.helm/
}

int() {
  bosh int ./src/tiller-certs.yml --vars-store ${CERTS_YAML} "$@"
}

case "${1:-usage}" in
    up)
        shift
        up
        ;;

    down)
        shift
        down
        ;;

    int)
        shift
        int "$@"
        ;;

    *)
        usage
        exit 1
        ;;
esac

