#!/bin/bash

set -eu

# Inputs to this script come from:
# * http://jayunit100.blogspot.com/2017/07/helm-on.html
# * https://github.com/helm/helm/blob/master/docs/tiller_ssl.md
# * https://github.com/helm/helm/blob/master/docs/securing_installation.md#best-practices-for-securing-helm-and-tiller

repo_root=$(dirname $(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd))

project_root=${HELM_MGR_PROJECT_ROOT:-${repo_root}}
state=${HELM_MGR_STATE_ROOT:-${project_root}/state}
cache=${state}/cache

export HELM_HOME=${HELM_HOME:-$(helm home)}

mkdir -p ${state}
mkdir -p ${cache}
tmp=$(mktemp -d)
trap "rm -fr ${tmp}" EXIT


usage() {
    echo "Helm/Tiller Deployment Manager CLI"
    echo "  up   -- deploys the Tiller to current Kubernetes context"
    echo "  down -- deletes to current Kubernetes context"
}

tiller_status() {
    kubectl -n kube-system get pods -l app=helm -o jsonpath='{.items[*].status.phase}' | sort | uniq
}

up() {
    echo "Creating certificates, if missing..."
    [[ -f ${state}/ca.key.pem ]] || {
        openssl genrsa -out ${state}/ca.key.pem 4096;
    }
    [[ -f ${state}/ca.cert.pem ]] || {
        openssl req \
            -key ${state}/ca.key.pem \
            -out ${state}/ca.cert.pem -new -x509 -days 7300 -sha256 \
            -subj "/O=tiller/CN=tiller"
    }
    [[ -f ${state}/tiller.key.pem ]] || {
        openssl genrsa -out ${state}/tiller.key.pem 4096
    }
    [[ -f ${state}tiller.csr.pem ]] || {
        openssl req \
            -key ${state}/tiller.key.pem -new -sha256 \
            -out ${state}/tiller.csr.pem \
            -subj "/O=Tiller Server/CN=tiller-server"
    }
    [[ -f ${state}/tiller.cert.pem ]] || {
        openssl x509 -req \
            -CA ${state}/ca.cert.pem -CAkey ${state}/ca.key.pem -CAcreateserial \
            -in ${state}/tiller.csr.pem \
            -out ${state}/tiller.cert.pem -days 365
    }

    echo "Installing helm into current Kuberenetes context..."
    kubectl apply -f ${project_root}/src/helm.yaml

    helm init \
        --service-account helm \
        --tiller-tls \
        --tiller-tls-verify \
        --tls-ca-cert     ${state}/ca.cert.pem \
        --tiller-tls-cert ${state}/tiller.cert.pem \
        --tiller-tls-key  ${state}/tiller.key.pem \
        --override 'spec.template.spec.containers[0].command'='{/tiller,--storage=secret}'

    echo "Installing helm client certificates..."
    cp ${state}/ca.cert.pem ${HELM_HOME}/ca.pem
    cp ${state}/tiller.cert.pem ${HELM_HOME}/cert.pem
    cp ${state}/tiller.key.pem ${HELM_HOME}/key.pem

    echo "Waiting for Tiller to start..."
    sleep 1
    status=$(tiller_status)
    echo "  ${status}"
    while [[ "${status}" != "Running" ]]; do
        status=$(tiller_status)
        echo "  ${status}"
        sleep 1
    done
    echo
    echo "Tiller is ready, testing connection and certificates:"
    helm ls --tls && echo working
}

down() {
    set +e
    kubectl delete deployment tiller-deploy --namespace=kube-system
    kubectl delete service tiller-deploy --namespace=kube-system
    kubectl delete secret tiller-secret -n kube-system
    kubectl delete -f ./src/helm.yaml
    rm -rf ~/.helm/
}

clean() {
    rm -rf ${state}
}

case "${1:-usage}" in
    up)
        shift
        up
        ;;

    down)
        shift
        down
        ;;

    clean)
        shift
        clean
        ;;

    *)
        usage
        exit 1
        ;;
esac

